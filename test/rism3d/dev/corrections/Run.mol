#!/bin/csh -f
#TEST-PROGRAM sander
#TEST-DESCRIP tests PCPLUS and UC corrections to determine if they give correct values based on Johnson et al. See README.
#TEST-PURPOSE developer, RISM correction accuracy
#TEST-STATE   OK

set pwd=`pwd`
set mol=`basename $pwd` 
set xvvpath=`dirname $0`
set closure=$1

# set the UC parameters for the closure
if ("$closure" == "kh") then
    set uccoeff="-0.14981795825894725,-0.11362660754037845,-0.000531632984563363,0.01039540047694473"
else if  ("$closure" == "pse3") then
    set uccoeff="-0.11852617876374648,-0.2633665220588354,-0.0005104617304254571,0.01040742243064981"
else if  ("$closure" == "hnc") then
    set uccoeff="-0.11869162361178422,-0.22080340779712096,-0.0005067809571377342,0.00965209953713459"
else
    echo
    echo "Only closures kh, pse3 and hnc are supported."
    goto usage
endif

echo "SANDER: 3D-RISM correction test for $mol with $closure"

if( ! $?TESTsander ) set TESTsander = "${AMBERHOME}/bin/sander"

if ! { ../../../checkrismunsupported.sh $TESTsander } exit 0

if( ! $?DO_PARALLEL ) then
        setenv DO_PARALLEL " "
else
        set numprocs=`echo $DO_PARALLEL | awk -f ../../../../numprocs.awk `
        if ( $numprocs > 1 ) then
            echo " DO_PARALLEL set to $DO_PARALLEL"
            goto toomany
        else if ( $?MP_PROCS)then
            if ($MP_PROCS > 1)then
#               --- For IBM AIX ---
                echo "    MP_PROCS set to "$MP_PROCS
                goto toomany
            endif
        endif
endif

cat > mdin <<EOF
$mol run
 &cntrl
    ntx=1, ntpr=1, ntwx=0,ntwr=0
    imin=1
    maxcyc=0
    ntt=0, ig=314159, tempi=0,
    ntp=0,
    ntc=1,ntf=1,
    ntb=0,
    irism=1
    cut=999,
 /
 &rism
    closure="$closure"
    tolerance=1e-10
    buffer = 30,
    grdspc=0.3,0.3,0.3
    verbose=1
    progress=1
    entropicDecomp=1
    gfCorrection = 1
    pcplusCorrection = 1
    uccoeff= $uccoeff
    treeDCF=.false.
    treeTCF=.false.
    treeCoulomb=.false.
    asympKSpaceTolerance = 0
    ljTolerance = 0
 /
EOF

$DO_PARALLEL $TESTsander -O -i mdin -o $mol-$closure.out\
   -p $mol.prmtop -c $mol.crd -xvv $xvvpath/cSPCE_$closure.xvv \
   || goto error

../../../../../AmberTools/test/nab/checkrism3d -err 1e-6 $mol-$closure.out.save $mol-$closure.out
/bin/rm -f mdin mdinfo restrt
exit(0)

error:
echo "  ${0}:  Program error"
exit(1)

toomany:
    echo " too many processors for this test, exiting"
    echo "============================================================"
    exit(0)

usage:
    echo
    echo "Usage: ../Run.mol <closure>"
    echo
    echo "Molecule name is the name of the current working directory."
    echo "<molecule>.crd and <molecule>.prmtop files are expected to be"
    echo "in the current working directory. cSPCE_<closure>.xvv should be"
    echo "in the same directory as this script."







